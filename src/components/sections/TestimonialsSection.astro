---
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";
import { resolveImage } from "../../utils/resolveImage";
import Button from "../ui/Button.astro";
import AppImage from "../ui/AppImage.astro";

const { testimonials } = Astro.props;
const titleHtml = testimonials.title.replace(
  "Customers'",
  '<span class="text-gradient">Customers\'</span>',
);
const testimonialGroups = Array.from({ length: 2 }, () => testimonials.items);

// Resolve common icons
const ratingIcon = await resolveImage(testimonials.ratingIcon);
const ratingInactiveIcon = await resolveImage(testimonials.ratingInactiveIcon);
const quoteIcon = await resolveImage(testimonials.quoteIcon);

// Resolve author images
const authorImages = await Promise.all(
  testimonials.items.map((item: any) => resolveImage(item.image)),
);
---

<section
  class="bg-[url('/src/assets/images/testmonial-bg.png')] bg-cover bg-center py-[var(--_typography-size---gap--section-gap)] text-white"
>
  <div
    class="mx-auto w-full px-[15px] max-w-[1330px] max-[991px]:max-w-[740px] max-[767px]:max-w-[530px] max-[479px]:max-w-full"
  >
    <div
      class="grid items-center gap-5 max-[991px]:grid-cols-1 max-[991px]:gap-[30px] min-[992px]:grid-cols-2 min-[1280px]:gap-10 min-[1440px]:gap-14"
    >
      <div
        class="max-w-[520px] min-[1280px]:max-w-[560px] min-[1440px]:max-w-[600px]"
      >
        <h2
          class="font-title text-[length:var(--_typography-size---typography--h2)] font-normal leading-[1.2] tracking-[-0.02em] text-white"
          set:html={titleHtml}
        />
        <div class="mt-5 max-w-[528px]">
          <p class="text-[18px] text-[#c4c4c4]">{testimonials.summary}</p>
        </div>
        <div
          class="mt-[30px] flex items-center gap-4 min-[1440px]:mt-12 max-[767px]:mt-5 max-[479px]:flex-wrap"
        >
          <Button href={testimonials.cta.href}>
            {testimonials.cta.label}
          </Button>
        </div>
      </div>
      <div
        class="relative flex max-h-[600px] flex-col gap-6 overflow-hidden min-[1280px]:max-h-[700px] min-[1440px]:max-h-[900px] max-[767px]:max-h-[500px]"
      >
        {
          testimonialGroups.map((group) => (
            <div class="flex flex-col gap-6">
              {group.map(
                (
                  item: {
                    image: string;
                    name: string;
                    title: string;
                    feedback: string;
                    role: string;
                  },
                  index: number,
                ) => (
                  <article class="flex flex-wrap gap-5 rounded-[16px] border border-[#ffffff4a] bg-[#0e1522] px-[25px] py-[30px] shadow-[0_8px_14px_#ffffff1a] min-[1280px]:flex-nowrap min-[1280px]:gap-5 min-[1440px]:gap-6 min-[1440px]:px-[34px] min-[1440px]:py-[40px] max-[991px]:flex-nowrap max-[991px]:p-5 max-[479px]:flex-wrap">
                    <div class="h-[96px] w-[96px] overflow-hidden rounded-full min-[1280px]:flex-none max-[991px]:h-[70px] max-[991px]:w-[70px]">
                      {typeof authorImages[index] === "string" ? (
                        <AppImage
                          src={authorImages[index] as string}
                          alt={item.name}
                          width="96"
                          height="96"
                          class="h-full w-full rounded-full object-cover"
                          loading="lazy"
                        />
                      ) : (
                        <Image
                          src={authorImages[index] as ImageMetadata}
                          alt={item.name}
                          width={96}
                          height={96}
                          class="h-full w-full rounded-full object-cover"
                          loading="lazy"
                        />
                      )}
                    </div>
                    <div class="flex-1">
                      <div class="flex items-center justify-between max-[479px]:flex-wrap max-[479px]:gap-4">
                        <h3 class="font-title text-[length:var(--_typography-size---typography--h4)] font-medium leading-[1.4] text-white">
                          {item.title}
                        </h3>
                        <div class="flex items-center gap-2">
                          {typeof ratingIcon === "string" ? (
                            <>
                              <AppImage
                                src={ratingIcon}
                                alt=""
                                width="16"
                                height="16"
                                class="h-4 w-4"
                                aria-hidden="true"
                              />
                              <AppImage
                                src={ratingIcon}
                                alt=""
                                width="16"
                                height="16"
                                class="h-4 w-4"
                                aria-hidden="true"
                              />
                              <AppImage
                                src={ratingIcon}
                                alt=""
                                width="16"
                                height="16"
                                class="h-4 w-4"
                                aria-hidden="true"
                              />
                              <AppImage
                                src={ratingIcon}
                                alt=""
                                width="16"
                                height="16"
                                class="h-4 w-4"
                                aria-hidden="true"
                              />
                              <AppImage
                                src={ratingInactiveIcon as string}
                                alt=""
                                width="16"
                                height="16"
                                class="h-4 w-4"
                                aria-hidden="true"
                              />
                            </>
                          ) : (
                            <>
                              <Image
                                src={ratingIcon as ImageMetadata}
                                alt=""
                                width={16}
                                height={16}
                                class="h-4 w-4"
                                aria-hidden="true"
                              />
                              <Image
                                src={ratingIcon as ImageMetadata}
                                alt=""
                                width={16}
                                height={16}
                                class="h-4 w-4"
                                aria-hidden="true"
                              />
                              <Image
                                src={ratingIcon as ImageMetadata}
                                alt=""
                                width={16}
                                height={16}
                                class="h-4 w-4"
                                aria-hidden="true"
                              />
                              <Image
                                src={ratingIcon as ImageMetadata}
                                alt=""
                                width={16}
                                height={16}
                                class="h-4 w-4"
                                aria-hidden="true"
                              />
                              <Image
                                src={ratingInactiveIcon as ImageMetadata}
                                alt=""
                                width={16}
                                height={16}
                                class="h-4 w-4"
                                aria-hidden="true"
                              />
                            </>
                          )}
                        </div>
                      </div>
                      <p class="mt-5 text-[16px] text-[#c4c4c4] min-[1440px]:mt-[34px]">
                        {item.feedback}
                      </p>
                      <div class="flex items-start justify-between">
                        <div class="mt-5">
                          <p class="font-title text-[16px] font-medium text-white">
                            {item.name}
                          </p>
                          <p class="mt-2 text-[14px] text-[#aaa]">
                            {item.role}
                          </p>
                        </div>
                        {typeof quoteIcon === "string" ? (
                          <AppImage
                            src={quoteIcon}
                            alt=""
                            width="32"
                            height="32"
                            class="mt-[15px] h-8 w-8 min-[1440px]:mt-5"
                            aria-hidden="true"
                          />
                        ) : (
                          <Image
                            src={quoteIcon as ImageMetadata}
                            alt=""
                            width={32}
                            height={32}
                            class="mt-[15px] h-8 w-8 min-[1440px]:mt-5"
                            aria-hidden="true"
                          />
                        )}
                      </div>
                    </div>
                  </article>
                ),
              )}
            </div>
          ))
        }
        <div
          class="pointer-events-none absolute inset-x-0 top-0 bottom-[70%] bg-[linear-gradient(#000,#0000)] min-[1280px]:bottom-[60%] min-[1440px]:bottom-[67%] max-[991px]:bottom-[75%] max-[767px]:bottom-[80%]"
        >
        </div>
        <div
          class="pointer-events-none absolute inset-x-0 bottom-0 top-[70%] bg-[linear-gradient(0deg,#000,#0000)] max-[991px]:top-[75%] max-[767px]:top-[80%]"
        >
        </div>
      </div>
    </div>
  </div>
</section>

