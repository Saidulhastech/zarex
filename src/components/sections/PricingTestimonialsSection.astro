---
import Container from "../ui/Container.astro";
import AppImage from "../ui/AppImage.astro";

const { testimonials } = Astro.props;
const fullStars = Array.from({ length: testimonials.rating.full });
const emptyStars = Array.from({ length: testimonials.rating.empty });
---

<section
  class="bg-[url('/src/assets/images/testimonial-bg-2.png')] bg-cover bg-center py-[var(--_typography-size---gap--section-gap)] text-white overflow-hidden"
>
  <Container>
    <div class="max-w-[700px]" data-pricing-testimonials-animate>
      <h2
        class="font-title text-[length:var(--_typography-size---typography--h2)] font-normal leading-[1.2] tracking-[-0.02em] text-white"
      >
        {testimonials.title.prefix}
        <span class="highlight-text">{testimonials.title.highlight}</span>
        {testimonials.title.suffix}
      </h2>
    </div>

    <div
      class="relative mt-[var(--_typography-size---gap--content-gap)] flex flex-col items-center"
      data-pricing-testimonials-animate
    >
      <div class="h-px w-[100vw] bg-[#88888878]"></div>
      <div class="relative flex w-full flex-col items-center">
        <div class="relative w-full overflow-visible">
          <div
            class="mx-auto max-w-[55%] overflow-x-auto scroll-smooth snap-x snap-mandatory max-[991px]:max-w-full"
          >
            <div class="flex">
              {
                testimonials.items.map(
                  (item: {
                    title: string;
                    feedback: string;
                    name: string;
                    role: string;
                  }) => (
                    <article class="min-w-full snap-start border-x-[0.5px] border-[#88888878] bg-transparent py-[40px] px-[30px]">
                      <h3 class="font-title text-[22px] font-medium leading-[1.4] text-white">
                        {item.title}
                      </h3>
                      <p class="mt-5 text-[22px] leading-[1.4] text-[#c4c4c4]">
                        {item.feedback}
                      </p>
                      <div class="mt-10 flex flex-wrap items-center justify-between gap-4">
                        <div>
                          <p class="font-title text-[18px] font-medium leading-[1.2] text-white">
                            {item.name}
                          </p>
                          <p class="mt-1 text-[14px] text-[#aaa]">
                            {item.role}
                          </p>
                        </div>
                        <div class="flex items-center gap-2">
                          {fullStars.map(() => (
                            <AppImage
                              src={testimonials.ratingIcon}
                              alt="Testimonial Rating Icon"
                              width="16"
                              height="16"
                              class="h-4 w-4"
                              loading="lazy"
                            />
                          ))}
                          {emptyStars.map(() => (
                            <AppImage
                              src={testimonials.ratingInactiveIcon}
                              alt="Testimonial Rating Icon"
                              width="16"
                              height="16"
                              class="h-4 w-4"
                              loading="lazy"
                            />
                          ))}
                        </div>
                      </div>
                    </article>
                  ),
                )
              }
            </div>
          </div>

          <button
            type="button"
            aria-label="Previous testimonial"
            class="absolute -top-[90px] right-[140px] flex h-[36px] w-[36px] items-center justify-center rounded-full border border-white text-white transition hover:border-transparent hover:bg-[#d8ae6b] hover:text-white"
          >
            <svg
              width="18"
              height="16"
              viewBox="0 0 18 16"
              fill="none"
              aria-hidden="true"
            >
              <path
                d="M8.37938 15.501L0.9375 8.00098L8.37938 0.500977M1.97156 8.00098H17.0625"
                stroke="currentColor"
                stroke-linecap="round"
                stroke-linejoin="round"></path>
            </svg>
          </button>
          <button
            type="button"
            aria-label="Next testimonial"
            class="absolute -top-[90px] right-0 flex h-[36px] w-[36px] items-center justify-center rounded-full border border-white text-white transition hover:border-transparent hover:bg-[#d8ae6b] hover:text-white"
          >
            <svg
              width="18"
              height="16"
              viewBox="0 0 18 16"
              fill="none"
              aria-hidden="true"
            >
              <path
                d="M9.62062 15.501L17.0625 8.00098L9.62062 0.500977M16.0284 8.00098H0.9375"
                stroke="currentColor"
                stroke-linecap="round"
                stroke-linejoin="round"></path>
            </svg>
          </button>
        </div>
      </div>
      <div class="h-px w-[100vw] bg-[#88888878]"></div>
    </div>
  </Container>
</section>

<style>
  [data-pricing-testimonials-animate] {
    opacity: 0;
    filter: blur(100px);
    transform: translateY(40px);
    transition:
      opacity 0.8s ease,
      filter 0.8s ease,
      transform 0.8s ease;
  }

  [data-pricing-testimonials-animate].animate-in {
    opacity: 1;
    filter: blur(0);
    transform: translateY(0);
  }
</style>

<script>
  const initPricingTestimonialsAnimation = () => {
    const animatedElements = document.querySelectorAll(
      "[data-pricing-testimonials-animate]",
    );

    if (!animatedElements.length) return;

    const observer = new IntersectionObserver(
      (entries: IntersectionObserverEntry[]) => {
        entries.forEach((entry: IntersectionObserverEntry) => {
          if (entry.isIntersecting) {
            const el = entry.target as HTMLElement;
            el.classList.add("animate-in");
            observer.unobserve(el);
          }
        });
      },
      {
        threshold: 0.2,
        rootMargin: "0px 0px -50px 0px",
      },
    );

    animatedElements.forEach((el) => observer.observe(el));
  };

  document.addEventListener(
    "DOMContentLoaded",
    initPricingTestimonialsAnimation,
  );
  document.addEventListener(
    "astro:page-load",
    initPricingTestimonialsAnimation,
  );
</script>

